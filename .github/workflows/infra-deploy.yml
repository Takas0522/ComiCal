# Infrastructure Deployment Workflow
# This workflow deploys the Bicep infrastructure to Azure
# It supports both dev and prod environments with semantic versioning

name: Infrastructure Deployment

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        type: choice
        options:
          - dev
          - prod
      dry_run:
        description: 'Perform a what-if deployment (no actual changes)'
        required: false
        type: boolean
        default: false
  push:
    branches:
      - main
      - feature/gen-iac
    paths:
      - 'infra/**'
      - '.github/workflows/infra-deploy.yml'
    tags:
      - 'v*.*.*'

permissions:
  id-token: write
  contents: read

env:
  AZURE_LOCATION: japaneast

jobs:
  validate:
    name: Validate Bicep Templates
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Azure CLI
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Validate Bicep syntax
        run: |
          az bicep build --file infra/main.bicep
          echo "✅ Bicep syntax validation passed"

      - name: Run Bicep linter
        run: |
          az bicep lint --file infra/main.bicep

  deploy-dev:
    name: Deploy to Development
    runs-on: ubuntu-latest
    needs: validate
    if: |
      (github.event_name == 'push' && !startsWith(github.ref, 'refs/tags/')) ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'dev')
    environment:
      name: dev
      url: https://portal.azure.com/#@/resource/subscriptions//resourceGroups/rg-comical-dev-jpe
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: What-If Deployment (Preview Changes)
        if: github.event.inputs.dry_run == 'true'
        run: |
          az deployment sub what-if \
            --name "comical-infra-dev-${{ github.run_number }}" \
            --location ${{ env.AZURE_LOCATION }} \
            --template-file infra/main.bicep \
            --parameters infra/parameters/dev.bicepparam \
            --parameters postgresAdminPassword="${{ secrets.POSTGRES_ADMIN_PASSWORD }}" \
            --parameters rakutenApiKey="${{ secrets.RAKUTEN_API_KEY }}" \
            --parameters deploymentPrincipalObjectId="${{ secrets.DEPLOYMENT_PRINCIPAL_OBJECT_ID }}"

      - name: Deploy Infrastructure
        if: github.event.inputs.dry_run != 'true'
        uses: azure/arm-deploy@v1
        with:
          scope: subscription
          subscriptionId: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          region: ${{ env.AZURE_LOCATION }}
          template: ./infra/main.bicep
          parameters: ./infra/parameters/dev.bicepparam postgresAdminPassword=${{ secrets.POSTGRES_ADMIN_PASSWORD }} rakutenApiKey=${{ secrets.RAKUTEN_API_KEY }} deploymentPrincipalObjectId=${{ secrets.DEPLOYMENT_PRINCIPAL_OBJECT_ID }}
          deploymentName: comical-infra-dev-${{ github.run_number }}

  deploy-prod:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: validate
    if: |
      (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')) ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'prod')
    environment:
      name: prod
      url: https://portal.azure.com/#@/resource/subscriptions//resourceGroups/rg-comical-prod-jpe
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract version tag
        id: version
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            VERSION="${GITHUB_REF#refs/tags/}"
          else
            VERSION=""
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Build deployment parameters
        id: params
        run: |
          # Common parameters for all deployments
          BASE_PARAMS="postgresAdminPassword=${{ secrets.POSTGRES_ADMIN_PASSWORD }} rakutenApiKey=${{ secrets.RAKUTEN_API_KEY }} deploymentPrincipalObjectId=${{ secrets.DEPLOYMENT_PRINCIPAL_OBJECT_ID }}"
          
          if [ -n "${{ steps.version.outputs.version }}" ]; then
            PARAMS="infra/parameters/prod.bicepparam gitTag=${{ steps.version.outputs.version }} $BASE_PARAMS"
          else
            PARAMS="infra/parameters/prod.bicepparam $BASE_PARAMS"
          fi
          
          echo "parameters=$PARAMS" >> $GITHUB_OUTPUT

      - name: What-If Deployment (Preview Changes)
        if: github.event.inputs.dry_run == 'true'
        run: |
          az deployment sub what-if \
            --name "comical-infra-prod-${{ github.run_number }}" \
            --location ${{ env.AZURE_LOCATION }} \
            --template-file infra/main.bicep \
            --parameters ${{ steps.params.outputs.parameters }}

      - name: Deploy Infrastructure
        if: github.event.inputs.dry_run != 'true'
        uses: azure/arm-deploy@v1
        with:
          scope: subscription
          subscriptionId: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          region: ${{ env.AZURE_LOCATION }}
          template: ./infra/main.bicep
          parameters: ${{ steps.params.outputs.parameters }}
          deploymentName: comical-infra-prod-${{ github.run_number }}

      - name: Validate semantic version
        if: steps.version.outputs.version != ''
        run: |
          echo "✅ Deployed with semantic version: ${{ steps.version.outputs.version }}"
